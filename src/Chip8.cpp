#include "Chip8.hpp"
#include <chrono>
#include <thread>

uint8_t Chip8Fonts[16][5] = {
	{0xF0, 0x90, 0x90, 0x90, 0xF0},		// 0
	{0x20, 0x60, 0x20, 0x20, 0x70},		// 1
	{0xF0, 0x10, 0xF0, 0x80, 0xF0},		// 2
	{0xF0, 0x10, 0xF0, 0x10, 0xF0},		// 3
	{0x90, 0x90, 0xF0, 0x10, 0x10},		// 4
	{0xF0, 0x80, 0xF0, 0x10, 0xF0},		// 5
	{0xF0, 0x80, 0xF0, 0x90, 0xF0},		// 6
	{0xF0, 0x10, 0x20, 0x40, 0x40},		// 7
	{0xF0, 0x90, 0xF0, 0x90, 0xF0},		// 8
	{0xF0, 0x90, 0xF0, 0x10, 0xF0},		// 9
	{0xF0, 0x90, 0xF0, 0x90, 0x90},		// A
	{0xE0, 0x90, 0xE0, 0x90, 0xE0},		// B
	{0xF0, 0x80, 0x80, 0x80, 0xF0},		// C
	{0xE0, 0x90, 0x90, 0x90, 0xE0},		// D
	{0xF0, 0x80, 0xF0, 0x80, 0xF0},		// E
	{0xF0, 0x80, 0xF0, 0x80, 0x80}		// F
};

Chip8::Chip8()
{
	m_RAM = new Memory(MEMORY_RAM_SIZE);
	m_STACK = new Memory(MEMORY_STACK_SIZE);
	m_Keyboard = new Keyboard();
	m_Display = new Display();
	m_Audio = new Audio();
	m_CPU = new CPU(m_RAM, m_STACK, m_Keyboard, m_Display, m_Audio, ADDRESS_START_OF_PROGRAM, ADDRESS_START_OF_FONT);
}

void Chip8::init(char* filename)
{
	m_CPU->loadROM(filename, ADDRESS_START_OF_PROGRAM);
	m_CPU->loadROM(&(Chip8Fonts[0][0]), ADDRESS_START_OF_FONT, sizeof(Chip8Fonts));
}

void Chip8::run()
{
	while (1)
	{
		m_Keyboard->processPress();
		m_CPU->execute();
		m_Display->render();
		m_Audio->play();

		std::this_thread::sleep_for(std::chrono::microseconds(50));
	}
}
